
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>/* steve jansen */</title>
  <meta name="author" content="Steve Jansen">

  
  <meta name="description" content="Thanks to some pretty awesome support from Jon Fanti and John Moore at ObjectRocket,
I learned this week that we had missed two key optimizations for &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://steve-jansen.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="/* steve jansen */" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-43558425-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">/* steve jansen */</a></h1>
  
    <h2>// another day in paradise hacking code and more</h2>
  
</hgroup>

</header>
  
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/01/integrating-rackspace-auto-scale-groups-with-objectrocket-mongo-databases/">Integrating Rackspace Auto Scale Groups With ObjectRocket Mongo Databases</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-01T13:00:58-05:00" pubdate data-updated="true">Dec 1<span>st</span>, 2014</time>
        
         | <a href="/blog/2014/12/01/integrating-rackspace-auto-scale-groups-with-objectrocket-mongo-databases/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Thanks to some pretty awesome support from Jon Fanti and John Moore at <a href="http://objectrocket.com">ObjectRocket</a>,
I learned this week that we had missed two key optimizations for using ObjectRocket MongoDBs with Rackspace
Auto Scaling groups (ASGs).</p>

<h2>ServiceNet</h2>

<p>First, ObjectRocket support can provide medium and large customers with a server FQDN that resolves to a
<a href="http://www.rackspace.com/knowledge_center/frequently-asked-question/what-is-servicenet">ServiceNet</a> private IP.
You can use this FQDN instead of the server name shown in the connect string for your instance.  As long
as your cloud servers and ObjectRocket are in the same Rackspace data center, the ServiceNet connection string
will avoid data transfer charges and keep your packets from transiting the public Internet.</p>

<h2>Dynamic IP ACLs</h2>

<p>We struggled to manually maintain the list of authorized IPs for our ObjectRocket MongoDB instances
when a ASG would add a new node.  We had a backlog plan to script the IP ACLs using Chef, but, hadn&rsquo;t
found the time yet.</p>

<p>Fortunately, ObjectRocket already supports this!  See <a href="https://app.objectrocket.com/external/rackspace">https://app.objectrocket.com/external/rackspace</a></p>

<p><img src="/images/2014-12-01.png" alt="Screenshot of ObjectRocket integration with Rackspace" /></p>

<p>According to John, the ObjectRocket integration with your Rackspace Cloud account will automatically sync
the IP ACLs with your list of current Cloud VMs.  Moreover, the integration will ignore any manual IP ACLs
you create (as long as your description doesn&rsquo;t use the <code>rax-</code> prefix).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/20/how-to-use-jenkins-to-monitor-cron-jobs/">How to Use Jenkins to Monitor Cron Jobs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-20T17:46:46-05:00" pubdate data-updated="true">Nov 20<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/11/20/how-to-use-jenkins-to-monitor-cron-jobs/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Cron jobs have a funny way of being ignored.  Either no one knows the job is failing because the job
doesn&rsquo;t tell anyone.   Or, the job is spamming your e-mail inbox many times a day, regardless of success
or failure, which means you just ignore the e-mails.</p>

<p>I&rsquo;ve seen the &ldquo;Monitor an external job&rdquo; option for new Jenkins jobs before, and never paid much attention.
Turns out it&rsquo;s a great bucket for storing logs and results of cron jobs.</p>

<p>The <a href="https://wiki.jenkins-ci.org/display/JENKINS/Monitoring+external+jobs">external-monitor-job</a> plugin
seems to ship with the Jenkins war file.  So, your Jenkins should have it out of the box.</p>

<p>Creating a job is pretty simple.  It&rsquo;s just a name and description.  Click &ldquo;New Item&rdquo; in Jenkins and
select the &ldquo;Monitor an external job&rdquo; option.  This creates a job of type <code>hudson.model.ExternalJob</code>.</p>

<p>The <a href="https://wiki.jenkins-ci.org/display/JENKINS/Monitoring+external+jobs">wiki</a> describes a
fairly complicated method to download the Jenkins jar files onto the server running
your cron jobs, and then use the Java runtime to run a jar with your cron script as an
argument.  The jar presumably forks your a new shell to run your desired cron command and
sends the output/result to Jenkins.</p>

<p>There&rsquo;s a much easier way to do this.  Redirect or <code>tee</code> your job&rsquo;s stdout/stderr output to a
temp file.  Then post the result code and log file via <code>curl</code> to Jenkins.  No need to
download jar files.  No need to even have Java runtime on the server.</p>

<p>Just POST a small XML document with the log contents (binary encoded) and the
exit code to Jenkins @ <code>/job/:jobName/postBuildResult</code> where <code>:jobName</code> is the
URL encoded name of your monitoring job in Jenkins.</p>

<figure class='code'><figcaption><span>[example cron script]</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'><span class="c"># example cron script to post logs to Jenkins</span>
</span><span class='line'>
</span><span class='line'><span class="c"># exit on error</span>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="nv">log</span><span class="o">=</span><span class="sb">`</span>mktemp -t tmp<span class="sb">`</span>
</span><span class='line'><span class="nv">timer</span><span class="o">=</span><span class="sb">`</span>date +<span class="s2">&quot;%s&quot;</span><span class="sb">`</span>
</span><span class='line'><span class="nv">jenkins_job</span><span class="o">=</span>my_monitoring_job
</span><span class='line'><span class="nv">jenkins_server</span><span class="o">=</span>http://jenkins.example.com:8080/jenkins/job/<span class="nv">$jenkins_job</span>/postBuildResult
</span><span class='line'><span class="c"># see http://jenkins.example.com:8080/me/configure to get your username and API token</span>
</span><span class='line'><span class="nv">jenkins_username</span><span class="o">=</span>myusername
</span><span class='line'><span class="nv">jenkins_token</span><span class="o">=</span>abcdef0123456789fedcba9876543210
</span><span class='line'>
</span><span class='line'><span class="k">function </span>banner<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="k">$(</span><span class="nb">printf</span> <span class="s1">&#39;#%.0s&#39;</span> <span class="o">{</span>1..80<span class="o">}</span><span class="k">)</span> &gt;&gt; <span class="s2">&quot;$log&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function </span>report<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">result</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'>  <span class="nv">timer</span><span class="o">=</span><span class="k">$((</span><span class="sb">`</span>date +<span class="s2">&quot;%s&quot;</span><span class="sb">`</span> <span class="o">-</span> <span class="nv">$timer</span><span class="k">))</span>
</span><span class='line'>
</span><span class='line'>  banner
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;`whoami`@`hostname -f` `date`: elapsed $timer second(s)&quot;</span> &gt;&gt; <span class="s2">&quot;$log&quot;</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;exit code $result&quot;</span> &gt;&gt; <span class="s2">&quot;$log&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># binary encode the log file for Jenkins</span>
</span><span class='line'>  <span class="nv">msg</span><span class="o">=</span><span class="sb">`</span>cat <span class="s2">&quot;$log&quot;</span> | hexdump -v -e <span class="s1">&#39;1/1 &quot;%02x&quot;&#39;</span><span class="sb">`</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># post the log to jenkins</span>
</span><span class='line'>  <span class="nb">echo </span>curl -X POST <span class="se">\</span>
</span><span class='line'>       -u <span class="s2">&quot;$jenkins_username:$jenkins_token&quot;</span> <span class="se">\</span>
</span><span class='line'>       -d <span class="s2">&quot;&lt;run&gt;&lt;log encoding=\&quot;hexBinary\&quot;&gt;$msg&lt;/log&gt;&lt;result&gt;$result&lt;/result&gt;&lt;duration&gt;$timer&lt;/duration&gt;&lt;/run&gt;&quot;</span> <span class="se">\</span>
</span><span class='line'>        <span class="nv">$jenkins_server</span>/job/<span class="nv">$jenkins_job</span>/postBuildResult
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">trap </span>report EXIT;
</span><span class='line'>
</span><span class='line'>banner
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;hello, world @ `date`!&quot;</span> | tee <span class="s2">&quot;$log&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>[sample `crontab -e` entry]</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">MAILTO</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
</span><span class='line'>0 * * * * /bin/sh /your/directory/myjob.sh
</span></code></pre></td></tr></table></div></figure>


<p>A sample of the build log on Jenkins with a green/red build status:</p>

<p><img src="images/2014-11-20.png" alt="Sample Jenkins Build Log" /></p>

<p>Credit to <a href="http://stackoverflow.com/a/25611940/1995977">Taytay on Stackoverflow.com</a>
for figuring out how to use <code>hexdump</code> to properly encode the XML for Jenkins.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/17/finding-chef-nodes-bootstrapped-in-the-last-x-hours/">Finding Chef Nodes Bootstrapped in the Last X Hours</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-17T18:47:44-04:00" pubdate data-updated="true">Oct 17<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/10/17/finding-chef-nodes-bootstrapped-in-the-last-x-hours/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I needed to write a script to garbage collect old nodes in Chef related to
auto-scaling groups.</p>

<p>I decided to search for nodes bootstrapped in the last X hours.</p>

<p>I experimented with ways to find nodes that have been up for less than X hours.
In this example, I search for nodes that have been up for 8 hours or less.
Of course, this assumes you never restart your nodes:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>knife exec -E 'search(:node, "uptime_seconds:[0 TO #{ 8 * 60 * 60 }]") { |n| puts n.name }'</span></code></pre></td></tr></table></div></figure>


<p>I also tried finding nodes that converged in the last 8 hours (which would have
to be combined with some other filter of course):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>knife exec -E 'b = Time.now.to_i; a = (b - (8*60*60)).to_i; search(:node, "ohai_time:[#{a} TO #{b}]") { |n| puts n.name }'</span></code></pre></td></tr></table></div></figure>


<p>Overall, I think the easiest option is to just set a node attribute like
&lsquo;bootstrap_date&rsquo; at bootstrap (or set it if it&rsquo;s nil).  This would be a clearcut
way to find out how old a node truly is.</p>

<p>One of my colleagues pointed out that <a href="https://github.com/opscode/chef-metal">Chef Metal</a>
sets a very handy <code>node['metal']['location']['allocated_at']</code> attribute that gets
the job done if you are spinning up new nodes with metal.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/03/regexes-for-the-serverspec-2-update/">Regexes for the Serverspec 2 Update</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-03T18:24:25-04:00" pubdate data-updated="true">Oct 3<span>rd</span>, 2014</time>
        
         | <a href="/blog/2014/10/03/regexes-for-the-serverspec-2-update/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The Serverspec team just released v2 of their outstanding testing library
today, after a very long beta period.  The v2 release had a
<a href="http://serverspec.org/changes-of-v2.html">few breaking breaking changes</a>
due to dropped rspec matchers that had been deprecated.</p>

<p>If your <a href="http://kitchen.ci/">test-kitchen</a> tests recently broke today,
here&rsquo;s a few regexes I used with Sublime Text&rsquo;s regex find/replace
to rewrite the dropped matchers for the new matchers.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>it\s*\{\s*(should|should_not)\s*return_(stdout|stderr)\s*\(?(\/.*\/)\)?\s*\}
</span><span class='line'>its(:\2) { \1 match \3 }
</span><span class='line'>
</span><span class='line'>it\s*\{\s*(should|should_not)\s*return_(stdout|stderr)\s*\(?(\".*\")\)?\s*\}
</span><span class='line'>its(:\2) { \1 contain \3 }
</span><span class='line'>
</span><span class='line'>it\s*\{\s*(should|should_not)\s*return_(stdout|stderr)\s*\(?('.*')\)?\s*\}
</span><span class='line'>its(:\2) { \1 contain \3 }
</span><span class='line'>
</span><span class='line'>it\s*\{\s*(should|should_not)\s*return_exit_status\s*(\d+)\s*\}
</span><span class='line'>its(:exit_status) { \1 eq \2 }</span></code></pre></td></tr></table></div></figure>


<p>Hopefully the kitchen busser project will one day add support for
Gemfile-style constraints on the test node, since busser always
<a href="https://github.com/test-kitchen/test-kitchen/issues/242#issuecomment-28991870">installs the latest version of a busser plugin gem today.</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/27/chefing-custom-nginx-configs-with-the-nginx-cookbook/">Chef&#8217;ing Custom Nginx Configs With the Nginx Cookbook</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-27T19:41:10-04:00" pubdate data-updated="true">Aug 27<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/08/27/chefing-custom-nginx-configs-with-the-nginx-cookbook/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The <a href="http://supermarket.getchef.com/cookbooks/nginx">nginx</a> cookbook has been
super helpful Chef&#8217;ing some web apps recently.  One thing I struggled to
understand was how to use my own custom conf, like <code>/etc/nginx/nginx.conf</code>, that
is optimized for how I use nginx.</p>

<p>One solution I tried, which is probably a Chef anti-pattern, is to only include
the nginx cookbook on the initial converge:</p>

<h2>The Wrong Way</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># the nginx community cookbook will relentlessly revert conf files,</span>
</span><span class='line'><span class="c1"># so avoid running it unless nginx isn&#39;t installed,</span>
</span><span class='line'><span class="c1"># or we explicitly reset/delete the node attribute</span>
</span><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;nginx&#39;</span> <span class="k">unless</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;nginx&#39;</span><span class="o">][</span><span class="s1">&#39;installed&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="o">[</span><span class="s1">&#39;nginx&#39;</span><span class="o">][</span><span class="s1">&#39;installed&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># our custom nginx.conf</span>
</span><span class='line'><span class="n">template</span> <span class="s1">&#39;/etc/nginx/nginx.conf&#39;</span> <span class="k">do</span>
</span><span class='line'>   <span class="n">source</span> <span class="s1">&#39;nginx.conf.erb&#39;</span>
</span><span class='line'>   <span class="n">owner</span> <span class="s1">&#39;root&#39;</span>
</span><span class='line'>   <span class="n">group</span> <span class="s1">&#39;root&#39;</span>
</span><span class='line'>   <span class="n">mode</span>  <span class="s1">&#39;0644&#39;</span>
</span><span class='line'>   <span class="n">notifies</span> <span class="ss">:reload</span><span class="p">,</span> <span class="s2">&quot;service[nginx]&quot;</span><span class="p">,</span> <span class="ss">:delayed</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I knew this was wrong when I wrote it.   Chef is all about idempotency.
But, I couldn&rsquo;t figure out a way to keep the nginx cookbook from reverting my
custom conf during subsequent converges, only to have my <code>template</code> restore my
custom conf a few seconds later.</p>

<h2>The Better Way</h2>

<p>The OpsCode blog <a href="http://www.getchef.com/blog/2013/12/03/doing-wrapper-cookbooks-right/">Doing Wrapper Cookbooks Right</a> shows the right way, and really opened my eyes on the power of
Chef&rsquo;s two phase model (compile, then converge).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;nginx&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># use our custom nginx.conf, rather than the one that ships in the nginx cookbook</span>
</span><span class='line'><span class="c1"># this avoids the nginx and my-app cookbooks from fighting for control of</span>
</span><span class='line'><span class="c1"># the same target file</span>
</span><span class='line'><span class="n">resources</span><span class="p">(</span><span class="s1">&#39;template[nginx.conf]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cookbook</span> <span class="s1">&#39;my-app&#39;</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/19/json-proxy-release-0-dot-2-0/">Json-proxy Release 0.2.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-19T10:20:56-04:00" pubdate data-updated="true">Jul 19<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/07/19/json-proxy-release-0-dot-2-0/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Happy to announce a new release of <a href="https://www.npmjs.org/package/json-proxy">json-proxy</a>, a
utility for HTML5 devs to run apps locally and proxy calls like <a href="http://localhost:9000/api">http://localhost:9000/api</a> to
a remote server, all without CORS or JSONP.</p>

<h2>Grunt Plugin</h2>

<p>This release includes better support for running as a grunt plugin.
A <a href="https://github.com/gruntjs/grunt-contrib-connect/pull/85">change in grunt-contrib-connect@0.8.0</a>
simplifies life for proxy plugins inside the livereload task of <code>grunt serve</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">livereload</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">middleware</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">connect</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">middlewares</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// inject json-proxy to the front of the default middlewares array</span>
</span><span class='line'>      <span class="c1">// requires grunt-contrib-connect v0.8.0+</span>
</span><span class='line'>      <span class="nx">middlewares</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span>
</span><span class='line'>        <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;json-proxy&#39;</span><span class="p">).</span><span class="nx">initialize</span><span class="p">({</span>
</span><span class='line'>          <span class="nx">proxy</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">forward</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>              <span class="s1">&#39;/api/&#39;</span><span class="o">:</span> <span class="s1">&#39;http://api.example.com:8080&#39;</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>              <span class="s1">&#39;X-Forwarded-User&#39;</span><span class="o">:</span> <span class="s1">&#39;John Doe&#39;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>      <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="nx">middlewares</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>SSL Endpoints</h2>

<p>This release adds support for proxying to HTTPS endpoints.   Here&rsquo;s a sample
config to forward <a href="http://localhost:9000/channel">http://localhost:9000/channel</a> to <a href="https://www.youtube.com/channel">https://www.youtube.com/channel</a> .</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;proxy&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;forward&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="s2">&quot;/channel&quot;</span><span class="o">:</span> <span class="s2">&quot;https://www.youtube.com:443&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>HTTP Proxy Gateways and Basic Authentication</h2>

<p>You can now pass your authentication credentials to a HTTP proxy gateway on
your LAN via the <code>proxy.gateway.auth</code> config setting.  The setting value
uses the <code>username:password</code> format for HTTP basic authentication
(without base64 encoding).  Here&rsquo;s an example config to proxying remote request
via <a href="http://proxy.example.com:8080">http://proxy.example.com:8080</a> as <code>proxyuser</code> with password <code>C0mp13x_!d0rd$$@P!</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;proxy&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;gateway&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="s2">&quot;protocol: &quot;</span><span class="nx">http</span><span class="o">:</span><span class="s2">&quot;,</span>
</span><span class='line'><span class="s2">      &quot;</span><span class="nx">host</span><span class="s2">&quot;: &quot;</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span><span class="s2">&quot;,</span>
</span><span class='line'><span class="s2">      &quot;</span><span class="nx">port</span><span class="s2">&quot;: 8080,</span>
</span><span class='line'><span class="s2">      &quot;</span><span class="nx">auth</span><span class="s2">&quot;: &quot;</span><span class="nx">proxyuser</span><span class="o">:</span><span class="nx">C0mp13x_</span><span class="o">!</span><span class="nx">d0rd$$</span><span class="err">@</span><span class="nx">P</span><span class="o">!</span><span class="s2">&quot; /** &#39;user:password&#39; **/</span>
</span><span class='line'><span class="s2">    },  </span>
</span><span class='line'><span class="s2">    &quot;</span><span class="nx">forward</span><span class="s2">&quot;: {</span>
</span><span class='line'><span class="s2">      &quot;</span><span class="o">/</span><span class="nx">api</span><span class="s2">&quot;: &quot;</span><span class="nx">http</span><span class="o">:</span><span class="c1">//api.example.com&quot;,</span>
</span><span class='line'>      <span class="s2">&quot;/foo/\\d+/bar&quot;</span><span class="o">:</span> <span class="s2">&quot;http://www.example.com&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="s2">&quot;/secure/&quot;</span><span class="o">:</span> <span class="s2">&quot;https://secure.example.com&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Upgrade to NodeJitsu http-proxy v1.1</h2>

<p>This release required heavy refactoring to use the
<a href="https://github.com/nodejitsu/node-http-proxy/blob/master/UPGRADING.md">latest bits of Nodejitsu&rsquo;s http-proxy v1.1</a></p>

<p>This was necessary since version prior to 1.0 are no longer actively supported.</p>

<h2>Housekeeping</h2>

<p>There&rsquo;s better unit test coverage, and the code validates against a
reasonable set of jshint linting rules.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/06/including-another-berksfile-in-your-berksfile/">Including Another Berksfile in Your Berksfile</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-06T13:11:57-04:00" pubdate data-updated="true">May 6<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/05/06/including-another-berksfile-in-your-berksfile/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As part of my cooking with <a href="http://www.getchef.com/downloads/chef-dk/">Chef&rsquo;s new workflow</a>,
I wanted Berkshelf to dynamically import the secondary dependencies of my site-cookbook&rsquo;s dependencies.</p>

<p>Thanks <a href="https://coderwall.com/p/j72egw">Vasily Mikhayliche&rsquo;s Coderwall post</a> and <a href="https://sethvargo.com/berksfile-magic/">Seth Vargo&rsquo;s post on Berks magic</a>, I was able to hack something
that worked for me with <a href="http://berkshelf.com/v2.0/">Berkshelf v2.0</a>. (We don&rsquo;t have time to migrate to Berks 3.0 for another couple of weeks, and this feature doesn&rsquo;t seem to be part of Berks 3.0).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># vi:ft=ruby:</span>
</span><span class='line'><span class="n">site</span> <span class="ss">:opscode</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Extension method to import secondary dependencies in a referenced site-cookbook</span>
</span><span class='line'><span class="c1"># using the constraints in the site-cookbook&#39;s Berkshelf file, rather than just</span>
</span><span class='line'><span class="c1"># the name of the dependencies in the site-cookbook&#39;s metadata.rb file</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># credit: https://sethvargo.com/berksfile-magic/</span>
</span><span class='line'><span class="c1">#         https://coderwall.com/p/j72egw</span>
</span><span class='line'><span class="k">def</span> <span class="nf">site_cookbook</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>  <span class="n">berksfile</span> <span class="o">=</span> <span class="s2">&quot;../</span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">/Berksfile&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">berksfile</span><span class="p">)</span>
</span><span class='line'>    <span class="n">contents</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">berksfile</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># comment out lines like `site :opscode`, which cannot be imported multiple times</span>
</span><span class='line'>    <span class="n">contents</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/(^\s*site\s)/</span><span class="p">,</span> <span class="s1">&#39;#\1&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># comment out lines like `metadata`, which cannot be imported multiple times</span>
</span><span class='line'>    <span class="n">contents</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/(^\s*metadata\s)/</span><span class="p">,</span> <span class="s1">&#39;#\1&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">instance_eval</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">cookbook</span> <span class="s1">&#39;nginx&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 2.4.4&#39;</span>
</span><span class='line'><span class="n">site_cookbook</span> <span class="s1">&#39;my-site-cookbook&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Happy cooking!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/05/adding-chef-encrypted-data-bags-to-source-control/">Adding Chef Encrypted Data Bags to Source Control</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-05T15:54:25-04:00" pubdate data-updated="true">May 5<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/05/05/adding-chef-encrypted-data-bags-to-source-control/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been using Chef for a bit now and generally a huge fan of the new
<a href="http://www.getchef.com/downloads/chef-dk/">Chef workflow</a>.</p>

<p>We are working hard to attain true continuous delivery and test driven development with Chef.
The devil is in the details now.</p>

<p>One small wrinkle in our effort has been marrying <a href="http://docs.opscode.com/chef/essentials_data_bags.html#encrypt-a-data-bag-item">encrypted data_bags</a> with our chef-repo in GitHub.</p>

<p>I don&rsquo;t want to type the optional argument <code>--secret-file ~/.chef/encrypted_data_bag_secret</code> everytime I interact with a data bag. So, I added this option to my <code>~/.chef/knife.rb</code> file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">knife</span><span class="o">[</span><span class="ss">:secret_file</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">current_dir</span><span class="si">}</span><span class="s2">/encrypted_data_bag_secret&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, this precludes me from easily exporting the edited file to disk.  The export will always be my secret plaintext,
not the encrypted ciphertext.   Not exactly what you want to commit to GitHub.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">knife</span> <span class="n">data_bag</span> <span class="n">create</span> <span class="n">users</span> <span class="n">jenkins</span>
</span><span class='line'><span class="c1"># DON&#39;T COMMIT THIS... the exported file will be unencrypted</span>
</span><span class='line'><span class="n">knife</span> <span class="n">data_bag</span> <span class="n">users</span> <span class="n">jenkins</span> <span class="o">--</span><span class="nb">format</span><span class="o">=</span><span class="n">json</span> <span class="o">&gt;</span> <span class="n">data_bags</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">jenkins</span><span class="o">.</span><span class="n">json</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, I decided to create a bash alias to temporarily disable the knife.rb setting and export the data bag to a file:</p>

<p>My <code>~/.bash_profile</code> file contains this alias:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">function</span> <span class="n">knife</span><span class="o">-</span><span class="n">ciphertext</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">sed</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;s/knife\[\:secret_file\]/</span><span class="se">\#</span><span class="s2">knife\[\:secret_file\]/&quot;</span>  <span class="o">-</span><span class="n">i</span> <span class="o">.</span><span class="n">bak</span>  <span class="o">~</span><span class="sr">/.chef/</span><span class="n">knife</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'>   <span class="n">knife</span> <span class="vg">$@</span> <span class="o">--</span><span class="nb">format</span><span class="o">=</span><span class="n">json</span>
</span><span class='line'>   <span class="n">mv</span>  <span class="o">~</span><span class="sr">/.chef/</span><span class="n">knife</span><span class="o">.</span><span class="n">rb</span><span class="o">.</span><span class="n">bak</span>  <span class="o">~</span><span class="sr">/.chef/</span><span class="n">knife</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">alias</span> <span class="n">knife</span><span class="o">-</span><span class="n">ciphertext</span><span class="o">=</span><span class="n">knife</span><span class="o">-</span><span class="n">ciphertext</span>
</span></code></pre></td></tr></table></div></figure>


<p>This bash function comments out the secret file option in knife.rb using sed&rsquo;s in-place editing.</p>

<p>Now I can commit the data bag in its encrypted format:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">knife</span><span class="o">-</span><span class="n">ciphertext</span> <span class="n">data_bag</span> <span class="n">show</span> <span class="n">users</span> <span class="n">jenkins</span> <span class="o">&gt;</span> <span class="n">data_bags</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">jenkins</span><span class="o">.</span><span class="n">json</span>
</span><span class='line'><span class="n">git</span> <span class="n">add</span> <span class="n">data_bags</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">jenkins</span><span class="o">.</span><span class="n">json</span>
</span><span class='line'><span class="n">git</span> <span class="n">commit</span> <span class="o">-</span><span class="n">m</span> <span class="s1">&#39;adding the latest jenkins data bag&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Happing cooking!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/16/a-better-iis-express-console-window/">A Better IIS Express Console Window</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-16T18:18:34-04:00" pubdate data-updated="true">Mar 16<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/03/16/a-better-iis-express-console-window/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>IIS Express is the <em>de facto</em>  server to use for local development of ASP.NET MVC and Web Api apps.  It&rsquo;s just like it&rsquo;s big brother IIS
minus a few features rarely used for local development.
Unlike it&rsquo;s big brother, IIS Express runs on demand as a regular console app under the security context of
your current login.  This makes it much easier to start and stop debugging sessions.</p>

<p>Being a console app is great &ndash; you can see <code>System.Diagnostics.Debug.Print</code> and <code>System.Diagnostics.Trace.Write</code>
output right in the console alongside IIS&#8217; usual log statements for HTTP requests.</p>

<p>A really useful trick is to create a Windows Explorer shortcut to iisexpress.exe, and open that shortcut iisexpress.exe.lnk file instead of directly
opening iisexpress.exe. There are two benefits to this:</p>

<ol>
<li><p>iisexpress.exe gets a dedicated icon on the Windows taskbar.  In the screenshot below, I can <code>WinKey + 5</code> to quickly switch to my IIS Express
console output.  (<code>WinKey + N</code> focuses/opens the Nth item on the taskbar; repeat as needed if you have multiple windows grouped for that taskbar icon).</p></li>
<li><p>I can customize the command prompt preferences for just iisexpress.exe.  In the screenshot below, I&rsquo;m using a smaller font in purple color, with the
window stretched the entire 1600 pixel width of my display. This helps greatly with the readability of long lines of text in the console output.</p></li>
</ol>


<p><img src="/images/2014-03-16-A.png" alt="Screenshot of the iisexpress.exe open in a custom window" /></p>

<p>Here&rsquo;s a closer look at the console ouptut:
<img src="/images/2014-03-16-H.png" alt="Screenshot of the iisexpress.exe open in a custom window" /></p>

<p>Here are screenshots of the Explorer settings I used for <code>C:\Program Files\IIS Express\iisexpress.exe.lnk</code>:</p>

<p><img src="/images/2014-03-16-B.png" alt="Screenshot of the iisexpress.exe.lnk settings" />
<img src="/images/2014-03-16-C.png" alt="Screenshot of the iisexpress.exe.lnk settings" />
<img src="/images/2014-03-16-D.png" alt="Screenshot of the iisexpress.exe.lnk settings" />
<img src="/images/2014-03-16-E.png" alt="Screenshot of the iisexpress.exe.lnk settings" />
<img src="/images/2014-03-16-F.png" alt="Screenshot of the iisexpress.exe.lnk settings" />
<img src="/images/2014-03-16-G.png" alt="Screenshot of the iisexpress.exe.lnk settings" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/03/15/how-to-verify-administrative-rights-in-a-windows-batch-script/">How to Verify Administrative Rights in a Windows Batch Script</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-15T18:50:08-04:00" pubdate data-updated="true">Mar 15<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/03/15/how-to-verify-administrative-rights-in-a-windows-batch-script/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>While working on automated provisioning of a Jenkins slave server on Windows, I needed
to verify that one of my batch scripts was running with administrative privileges.</p>

<p>Turns out this problem is easy to solve these days as long as you don&rsquo;t need to support
XP.  Thanks to <a href="http://stackoverflow.com/a/21295806/1995977">and31415 on SO</a> for the
great post on using <code>fsutil</code>!</p>

<p>Here&rsquo;s a working example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">@ECHO OFF</span>
</span><span class='line'><span class="go">SETLOCAL ENABLEEXTENSIONS</span>
</span><span class='line'>
</span><span class='line'><span class="go">:: verify we have admin privileges</span>
</span><span class='line'><span class="go">CALL :IsAdmin || (ECHO %~n0: ERROR - administrative privileges required &amp;&amp; EXIT /B 1)</span>
</span><span class='line'>
</span><span class='line'><span class="go">ECHO &quot;Hello, Admin!&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="go">:EXIT</span>
</span><span class='line'><span class="go">EXIT /B</span>
</span><span class='line'>
</span><span class='line'><span class="go">:: function to verify admin/UAC privileges</span>
</span><span class='line'><span class="go">:: CREDIT: http://stackoverflow.com/a/21295806/1995977</span>
</span><span class='line'><span class="go">:IsAdmin</span>
</span><span class='line'><span class="go">IF NOT EXIST &quot;%SYSTEMROOT%\system32\fsutil.exe&quot; (</span>
</span><span class='line'><span class="go">  ECHO %~n0: WARNING - fsutil command not found; cannot verify adminstrative rights</span>
</span><span class='line'><span class="go">) ELSE (</span>
</span><span class='line'><span class="go">  &quot;%SYSTEMROOT%\system32\fsutil.exe&quot; dirty query &quot;%SystemDrive%&quot; &gt;NUL 2&gt;&amp;1</span>
</span><span class='line'><span class="go">)</span>
</span><span class='line'><span class="go">EXIT /B</span>
</span></code></pre></td></tr></table></div></figure>


<p>Shameless plug &ndash; learn more tips and tricks for batch scripting in my <a href="/guides/windows-batch-scripting/">Guide to Windows Batch Scripting</a>!</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
<section>
	<span>
		<img src="http://www.gravatar.com/avatar/9ece5a08fa2e47180dc50d1e31f92e2f?s=200" alt="Gravatar of Steve Jansen " title="Gravatar of Steve Jansen" style="display: block; margin-left:auto; margin-right: auto" />
	</span>
</section>
<section>
  <p style="clear:both">
    Hi, I&#8217;m Steve.  I&#8217;m a software developer loving life in Charlotte, NC,
    an (ISC)<sup>2</sup> <a href="https://www.isc2.org/csslp/default.aspx">CSSLP</a>
    and an avid fan of <a href="http://www.crossfit.com">Crossfit</a>.
  </p>
  <p>
    And, no, I&#8217;m not Steve Jansen the British jazz drummer, though that does sound like a sweet career.
  </p>
</section>

<section>
  <h1>Guides</h1>
  <ul id="recent_posts">
      <li class="post">
        <a href="/guides/windows-batch-scripting/index.html">Guide to Windows Batch Scripting</a>
      </li>
  </ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/12/01/integrating-rackspace-auto-scale-groups-with-objectrocket-mongo-databases/">Integrating Rackspace Auto Scale Groups with ObjectRocket Mongo databases</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/20/how-to-use-jenkins-to-monitor-cron-jobs/">How to use Jenkins to monitor cron jobs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/17/finding-chef-nodes-bootstrapped-in-the-last-x-hours/">Finding Chef nodes bootstrapped in the last X hours</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/03/regexes-for-the-serverspec-2-update/">regexes for the serverspec 2 update</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/27/chefing-custom-nginx-configs-with-the-nginx-cookbook/">Chef&#8217;ing custom nginx configs with the nginx cookbook</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Social Stuff</h1>
  <ul>
    
      <li /><a href="https://github.com/steve-jansen">@steve-jansen</a> on GitHub
    
    <li /><a href="http://stackoverflow.com/users/1995977/steve-jansen">@steve-jansen</a> on StackOverflow
    <li /><a href="https://coderwall.com/p/u/steve-jansen">@steve-jansen</a> ProTips on Coderwall
    <li /><a href="https://connect.microsoft.com/SQLServer/SearchResults.aspx?UserHandle=steve-jansen">@steve-jansen</a> on Microsft Connect
    <li /><a href="http://aspnet.uservoice.com/users/33548256-steve-jansen">@steve-jansen</a> on ASP.NET User Voice
    <li /><a href="/atom.xml" title="Subscribe via RSS">Subscribe via RSS</a>
  </ul>
</section>

<!--<a href="https://coderwall.com/steve-jansen"><img alt="Endorse steve-jansen on Coderwall" src="https://api.coderwall.com/steve-jansen/endorsecount.png" /></a>&#8211;>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Steve Jansen -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'steve-jansen';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
